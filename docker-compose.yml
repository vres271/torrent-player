services:
  amnezia-vpn:
    image: isonecom/amneziawg-client:latest
    container_name: amnezia-vpn
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./vpn-user-config/wg0.conf:/config/wg0.conf:ro
      - ./vpn:/vpn:ro
    entrypoint: ["/bin/sh","-c"]
    command:
      - |
        set -e

        /vpn/generate-wg0-setconf.sh

        amneziawg-go wg0
        awg setconf wg0 /config/wg0.setconf

        ADDR="$$(awk -F' *= *' '/^Address[[:space:]]*=/{print $$2; exit}' /config/wg0.conf)"
        ip -4 addr add "$$ADDR" dev wg0 || true

        ip link set mtu 1420 up dev wg0

        DNS="$$(awk -F' *= *' '/^DNS[[:space:]]*=/{print $$2; exit}' /config/wg0.conf)"
        if [ -n "$$DNS" ]; then
          printf "nameserver %s\n" "$$DNS" > /etc/resolv.conf
        fi

        ENDPOINT_IP="$$(awk -F'[ =:]+' '/^Endpoint/ {print $$2; exit}' /config/wg0.setconf)"
        GW="$$(ip route show default | awk '{print $$3}' | head -n1)"
        if [ -n "$$ENDPOINT_IP" ] && [ -n "$$GW" ]; then
          ip route replace "$$ENDPOINT_IP/32" via "$$GW"
        fi

        ip route replace default dev wg0

        tail -f /dev/null

  normal-app:
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: normal-app
    restart: unless-stopped
    environment:
      - PORT=3001
      - MODE=NORMAL
    expose:
      - "3001"

  vpn-app:
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: vpn-app
    restart: unless-stopped
    depends_on:
      - amnezia-vpn
    network_mode: service:amnezia-vpn
    environment:
      - PORT=3002
      - MODE=VPN

  webui:
    build:
      context: .
      dockerfile: Dockerfile.webui
    container_name: webui
    restart: unless-stopped
    depends_on:
      - normal-app
      - vpn-app
    ports:
      - "8089:8080"
    environment:
      - PORT=8080
      - NORMAL_URL=http://normal-app:3001/test
      - VPN_URL=http://amnezia-vpn:3002/test
      - TORAPI_BASE=http://amnezia-vpn:8443
      - QB_URL=http://qbittorrent:8081
      - QB_USER=admin
      - QB_PASS=adminadmin
  torapi:
    image: lifailon/torapi:latest
    container_name: torapi
    restart: unless-stopped
    depends_on:
      - amnezia-vpn
    network_mode: service:amnezia-vpn
    # TorAPI будет доступен внутри сети как amnezia-vpn:8443, т.к. делит netns

  dl-proxy:
    image: node:20-slim
    container_name: dl-proxy
    restart: unless-stopped
    depends_on:
      - amnezia-vpn
    network_mode: service:amnezia-vpn
    volumes:
      - ./dl-proxy/server.js:/app/server.js:ro
    working_dir: /app
    command: ["/bin/sh","-ec","node /app/server.js"]

  qbittorrent:
    image: linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    environment:
      - PUID=1000  # твой UID (id -u)
      - PGID=1000  # твой GID (id -g)
      - TZ=Europe/Moscow
      - WEBUI_PORT=8081
    volumes:
      - ./torrents:/downloads  # общая папка с хостом
      - ./qb-config:/config    # настройки
    ports:
      - "8081:8081"      # WebUI с хоста
      - "6881:6881"      # торрент TCP
      - "6881:6881/udp"  # торрент UDP

